name: "ğŸš€ Build EzBill APK - by Abhishek Kumar"

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  push:
    tags:
      - 'v*.*.*'

env:
  APP_NAME: "EzBill"
  PACKAGE_NAME: "com.ezbill.invoicegen"
  DEVELOPER: "Abhishek Kumar"

jobs:
  build-android:
    name: "ğŸ“± Build Android APK"
    runs-on: ubuntu-latest
    
    steps:
      - name: "ğŸ“¥ Checkout Repository"
        uses: actions/checkout@v4
        
      - name: "ğŸ“… Set Build Date"
        run: echo "BUILD_DATE=$(date +'%Y-%m-%d_%H-%M')" >> $GITHUB_ENV
        
      - name: "â˜• Setup Java JDK 17"
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: 'gradle'
          
      - name: "ğŸŸ¢ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: "ğŸ“¦ Install Dependencies"
        run: |
          npm ci
          npm install -g @capacitor/cli
          
      - name: "âš™ï¸ Setup Capacitor Android"
        run: |
          npx cap add android
          npx cap sync android
          
      - name: "ğŸ”§ Make Gradlew Executable"
        run: chmod +x android/gradlew
        
      - name: "ğŸ”¨ Build Debug APK"
        working-directory: android
        run: |
          ./gradlew clean
          ./gradlew assembleDebug
          
      - name: "ğŸ”¨ Build Release APK"
        if: startsWith(github.ref, 'refs/tags/v')
        working-directory: android
        run: ./gradlew assembleRelease
        
      - name: "ğŸ·ï¸ Rename APK Files"
        run: |
          if [ -f android/app/build/outputs/apk/debug/app-debug.apk ]; then
            mv android/app/build/outputs/apk/debug/app-debug.apk "EzBill-v1.0-debug-${{ env.BUILD_DATE }}.apk"
          fi
          if [ -f android/app/build/outputs/apk/release/app-release.apk ]; then
            mv android/app/build/outputs/apk/release/app-release.apk "EzBill-v1.0-release-${{ env.BUILD_DATE }}.apk"
          fi
          
      - name: "ğŸ“¤ Upload Debug APK"
        uses: actions/upload-artifact@v4
        with:
          name: "EzBill-Debug-APK-${{ env.BUILD_DATE }}"
          path: "EzBill-v1.0-debug-${{ env.BUILD_DATE }}.apk"
          retention-days: 30
          
      - name: "ğŸ“¤ Upload Release APK"
        if: startsWith(github.ref, 'refs/tags/v')
        uses: actions/upload-artifact@v4
        with:
          name: "EzBill-Release-APK-${{ env.BUILD_DATE }}"
          path: "EzBill-v1.0-release-${{ env.BUILD_DATE }}.apk"
          retention-days: 90
          
      - name: "ğŸ‰ Create GitHub Release"
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          name: "EzBill ${{ github.ref_name }} - by Abhishek Kumar"
          body: |
            # ğŸ‰ EzBill ${{ github.ref_name }} Released!
            
            **Developer:** Abhishek Kumar
            **Build Date:** ${{ env.BUILD_DATE }}
            **Package:** ${{ env.PACKAGE_NAME }}
            
            ## ğŸ“± What's New in EzBill:
            - âœ… Professional Invoice Generator
            - âœ… Offline-First Functionality  
            - âœ… GST Calculations & UPI QR Codes
            - âœ… Business Analytics Dashboard
            - âœ… Modern UI with Dark/Light Theme
            - âœ… Works on Android 7.0+
            
            ## ğŸ“² Installation:
            1. Download APK file below
            2. Enable "Unknown Sources" in Android Settings
            3. Install APK and enjoy EzBill!
            
            ## ğŸ”§ Technical Details:
            - **App Size:** ~12-15 MB
            - **Android Version:** 7.0+ (API 24+)
            - **Architecture:** Universal (ARM, x86)
            - **Permissions:** Storage (for PDF export)
            
            ---
            **Made with â¤ï¸ by Abhishek Kumar**
          files: |
            EzBill-v1.0-release-${{ env.BUILD_DATE }}.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: "âœ… Build Completed Successfully"
        run: |
          echo "ğŸ‰ EzBill APK Build Completed!"
          echo "ğŸ“± App Name: ${{ env.APP_NAME }}"
          echo "ğŸ‘¨â€ğŸ’» Developer: ${{ env.DEVELOPER }}"
          echo "ğŸ“… Build Date: ${{ env.BUILD_DATE }}"
          echo ""
          echo "ğŸ“¥ Download Links:"
          echo "- Debug APK: Available in GitHub Actions Artifacts"
          if [[ $GITHUB_REF == refs/tags/v* ]]; then
            echo "- Release APK: Available in GitHub Releases"
          fi
